
<!DOCTYPE html>
<html>


<head>
<title> Visualizing snake </title>
</head>


<body>

<div class="panel">
<canvas id="canvas" width="1000" height="600" style="position:relative; top:50px; left:50px"></canvas>
</div>

<script>

var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
 
boardx = 10;
boardy = 10;
cellS = 40;
windx = 1000;
windy = 600;
marginx = (windx - boardx * cellS) / 2
marginy = (windy - boardy * cellS) / 2
border = 5
snakeWidth = 20
appleSize = 20
textSize = 20

framesPerMove = 7

dir = [[0,1], [1,0], [0,-1], [-1,0]];

pi = Math.PI;

space = "#fff"
cLine = "#000"
cShade = "#eee"
cSnake = "#00f"
cApple = "#f00"
cText = "#000"

cValue = "#d00"
cSearch = "#bb0"
cNetwork = "#0d0"

TIME_LIMIT = 1200

function randint(max){
    return Math.floor(Math.random()*max)
}

class Environment{
    constructor(){
        this.timer = 0
        this.score = 0;
        this.actionType = 0;
        this.snakeSize = 2;
        this.headx = boardx/2;
        this.heady = 2;
        this.tailx = this.headx;
        this.taily = 1;

        this.snake = []
        for(var i=0; i<boardx; i++){
            this.snake[i] = []
            for(var j=0; j<boardy; j++){
                this.snake[i][j] = -1;
            }
        }
        this.snake[this.headx][this.heady] = 4;
        this.snake[this.tailx][this.taily] = 0;
        this.applex = 0;
        this.appley = 0;
    }

    agentAction(actionIndex){
        this.timer ++
        var newHeadx = this.headx + dir[actionIndex][0];
        var newHeady = this.heady + dir[actionIndex][1];
        this.snake[this.headx][this.heady] = actionIndex;
        this.headx = newHeadx;
        this.heady = newHeady;
        this.snake[newHeadx][newHeady] = 4;

        if(this.headx == this.applex && this.heady == this.appley){
            this.score += 1;
            //score += 1 - timer*0.5/maxTime;
            this.snakeSize++;
            this.actionType = 1;
        }
        else{
            var tailDir = this.snake[this.tailx][this.taily];
            this.snake[this.tailx][this.taily] = -1;
            this.tailx += dir[tailDir][0];
            this.taily += dir[tailDir][1];
        }
    }

    chanceAction(actionIndex){
        this.applex = Math.floor(actionIndex / boardy);
        this.appley = actionIndex % boardy;
        this.actionType = 0
    }

    validAgentAction(d){
        var newHeadx = this.headx + dir[d][0];
        var newHeady = this.heady + dir[d][1];
        if(newHeadx == -1 || newHeadx == boardx){
            return false;
        }
        if(newHeady == -1 || newHeady == boardy){
            return false;
        }
        return this.snake[newHeadx][newHeady] == -1;
    }

    randomChanceAction(){
        while(true){
            this.applex = randint(boardx)
            this.appley = randint(boardy)
            if(this.snake[this.applex][this.appley] == -1){
                break
            }
        }
        this.actionType = 0
    }
}

env = new Environment();

//Agent game:
actions = [61,1,2,98,1,0,1,0,0,0,0,0,0,1,48,0,3,3,3,2,41,2,2,2,2,2,2,2,14,3,0,3,3,0,0,93,1,2,1,1,1,1,1,1,28,0,3,3,3,3,0,3,0,3,0,3,0,30,3,2,2,1,2,2,2,2,2,1,4,0,0,0,0,0,3,3,2,3,22,2,2,1,0,2,85,1,1,2,1,1,1,0,0,1,0,0,45,3,3,3,3,67,0,1,0,1,88,0,1,1,92,1,2,2,2,2,2,37,3,3,3,0,3,0,3,0,0,0,3,9,0,0,3,3,3,78,2,2,1,0,0,1,1,0,1,1,1,0,0,93,1,2,2,2,1,2,2,13,2,3,0,3,3,3,3,3,3,3,75,3,0,1,1,1,1,1,1,1,0,26,3,3,3,0,3,2,0,6,3,2,42,0,0,1,1,2,3,3,1,2,2,3,2,2,2,3,3,3,3,3,0,46,1,0,3,0,0,2,3,1,1,1,1,2,3,21,3,3,2,2,2,2,73,1,0,1,1,1,1,0,35,3,3,3,3,0,48,2,0,0,0,0,3,3,98,0,1,1,1,86,2,2,3,16,2,1,2,2,2,2,3,3,3,3,3,3,3,3,0,0,0,0,0,1,23,2,2,2,1,8,0,0,0,0,3,3,41,0,2,0,2,2,2,2,2,2,2,2,1,89,0,0,0,0,0,0,0,0,1,1,1,88,2,1,3,2,2,2,3,3,2,2,2,2,2,3,3,3,95,1,1,0,0,0,3,2,3,0,0,0,0,2,1,0,1,1,1,1,1,2,2,2,57,3,0,3,3,0,3,87,2,2,3,2,3,2,2,2,1,1,1,0,1,2,2,3,0,0,0,0,0,1,1,0,1,1,1,2,73,1,2,2,2,3,3,75,0,1,3,12,3,2,2,2,3,2,2,2,3,0,0,3,69,2,2,1,1,0,1,2,1,0,0,0,0,1,6,1,1,1,2,2,2,2,2,2,2,2,0,3,2,2,2,2,3,3,3,3,0,3,0,0,0,53,1,2,2,2,1,1,1,7,0,3,3,3,0,0,3,3,86,0,1,1,1,1,1,1,1,1,2,2,3,36,3,3,3,3,3,47,0,1,50,0,1,1,2,1,0]
values = [2.584,2.72,2.86316,1.86316,1.96122,2.06444,2.17309,2.28747,2.40786,2.53459,2.66799,2.80841,2.95622,3.11181,2.11181,2.46311,2.59275,2.72921,2.87285,3.02406,2.02406,2.13059,2.24272,2.36076,2.48501,2.6158,2.75347,2.89839,1.89839,1.99831,2.10348,2.21419,2.33073,2.4534,2.58252,1.58252,1.66582,1.84578,1.94293,2.04518,2.15283,2.26613,2.3854,2.51095,1.51095,1.59047,1.67418,1.7623,1.85505,1.95268,2.05546,2.16364,2.27752,2.39738,2.52356,2.65638,2.79619,1.79619,1.89073,1.99024,2.09499,2.32132,2.44349,2.5721,2.70747,2.84997,2.99997,3.15786,2.15786,2.27143,2.39098,2.51682,2.64929,2.78872,2.9355,3.09,3.25263,3.42382,2.42382,2.55139,2.68567,2.82702,3.13244,3.2973,2.2973,2.41821,2.54549,2.67946,2.82048,2.96893,3.12519,3.28967,3.46281,3.64507,3.83691,4.03886,3.03886,3.1988,3.36715,3.54437,3.73092,2.73092,2.87465,3.02595,3.18521,3.35285,2.35285,2.47669,2.60704,2.74425,1.74425,1.83605,1.93269,2.03441,2.25419,2.37283,2.49772,1.49772,1.57655,1.65952,1.74686,1.8388,1.93558,2.03746,2.14469,2.25757,2.37639,2.50146,2.63312,1.63312,1.71907,1.80955,1.90479,2.00504,2.11057,1.16902,1.23055,1.29531,1.36349,1.43525,1.76211,1.95248,2.05524,2.16341,2.27727,2.39713,2.5233,2.6561,2.7959,1.7959,1.89042,1.98991,2.09464,2.20489,2.32094,2.44309,2.57167,1.57167,1.65439,1.74147,1.83312,1.9296,2.03116,2.13806,2.25059,2.36905,2.49373,2.62498,1.62498,1.71051,1.80053,1.8953,1.99505,2.10005,2.21058,2.32693,2.4494,2.57832,2.71402,1.71402,1.80423,1.89919,1.99914,2.10436,2.21512,2.45443,2.58361,1.58361,1.66695,1.94425,0.99395,1.04626,1.15929,1.22031,1.28454,1.35214,1.42331,1.83942,1.93623,2.03814,2.14541,2.25833,2.37719,2.5023,2.634,1.634,1.72,1.81053,1.90582,2.00612,2.11171,1.11171,1.17022,1.23181,1.36489,1.43672,1.85676,1.95448,2.16563,2.27961,2.39959,2.52589,2.65883,2.79877,2.94607,2.04849,2.15631,2.51501,2.64738,2.78672,2.93339,3.08778,2.08778,2.19766,2.31333,2.43508,2.56324,2.69815,2.84016,2.98964,1.98964,2.09436,2.20459,2.32062,2.57132,2.70666,1.79648,1.99056,2.20561,2.32169,2.44389,2.57251,2.70791,2.85043,1.85043,1.94782,2.27184,2.39141,2.64976,1.64976,1.73659,1.82799,1.9242,0.924201,0.972843,1.07794,1.13468,1.1944,1.25726,1.39309,1.46641,1.54358,1.62483,1.71034,1.80036,1.89512,1.99486,2.21037,2.32671,2.44916,2.57807,2.71376,2.85659,3.00693,2.00693,2.11256,2.22375,2.34079,2.46399,1.46399,1.54104,1.62214,1.70752,1.79739,1.89199,2.09639,1.09639,1.21483,1.34608,1.4915,1.57,1.65263,1.73961,1.83117,1.92754,2.02899,2.13578,2.24819,2.36652,1.36652,1.43844,1.51415,1.59384,1.67773,1.76603,1.85898,1.95682,2.16822,2.28234,2.40246,2.5289,1.5289,1.60937,0.609373,0.641445,0.675205,0.710743,0.74815,0.787526,0.828975,0.872605,0.918532,0.966876,1.01776,1.07133,1.24955,1.31531,1.45741,0.45741,0.481485,0.533501,0.56158,0.591137,0.622249,0.654999,0.689473,0.725761,0.804167,0.846492,0.891044,0.987306,1.03927,1.09397,1.21215,1.27595,1.34311,1.4138,1.56653,1.73577,1.82713,1.92329,2.02452,1.02452,1.07844,1.1352,1.19495,1.25784,1.32404,1.39373,0.393727,0.414449,0.436262,0.459223,0.483393,0.508835,0.535616,0.563806,0.59348,0.624716,0.657595,0.692206,0.728638,0.766987,0.807355,0.849847,1.0983,1.15611,1.21696,1.28101,1.34843,1.4194,1.57274,1.74265,1.83437,1.93091,2.03254,2.13952,2.37066,1.4428,1.51873,1.77138,1.86461,1.96274,2.06604,2.17478,1.17478,1.23661,1.37021,1.44233,0.442327,0.465607,0.490113,0.543061,0.60173,0.6334,0.861661,0.907011,0.954749,1.23387,1.29882,1.36717,1.43913,0.439131,0.462243,0.597382,0.628823,0.661919,0.696757,0.733429,0.855435,0.947851,0.997737,1.05025,1.10553,1.16371,1.22496,0.22496,0.2368,0.249263,0.276192,0.290728,0.30603,0.322136,0.339091,0.356938,0.375724,0.395499,0.511125,0.538027,0.566344,0.596151,0.627528,0.660556,0.731918,0.770439,0.810989,0.853673,0.945898,0.995682,1.42579,1.50083,1.57982,1.66297,0.66297,0.697863,0.734593,0.773256,0.856793,0.901887,0.949355,0.999321,-0.000678742,-0.000714465,-0.000752069,-0.000791651,-0.000877176,-0.000923343,-0.00097194,-0.00102309,-0.00107694,-1.05377,-1.16761,-1.22906,-1.29375,-1.36184,-1.43351,-1.50896,-1.58838,-1.67198,-1.85261,-1.95012,-2.05275,-2.16079,-3.16079,-3.32715,-3.50226,-3.68659,-3.88063,-4.08487,-5.08487,-5.35249,-5.6342,-6.6342,-6.98337,-7.35092,-7.73781,-8.14506,-8.57375,-10]
network_values = [2.9591,2.96337,3.32028,1.63752,1.64106,1.73758,1.88106,2.0932,2.4762,2.28434,2.61038,2.74704,2.80607,3.06479,2.49038,2.75911,3.09237,3.12504,3.27645,3.16815,2.17472,2.2459,2.27839,2.71985,2.6385,2.95732,2.94755,3.18684,2.12223,2.66789,2.66344,2.75982,2.71583,2.85346,3.1162,1.52457,2.00233,1.8389,2.21488,2.56732,2.49126,2.70669,3.01012,3.14933,1.89275,2.02894,1.87776,1.50063,1.81258,2.03351,2.26091,2.36788,2.49065,2.62093,2.57538,3.01807,3.0778,1.75174,1.80302,1.85578,2.06841,1.88255,2.22238,2.40438,2.59633,2.80393,2.94918,2.94657,2.06836,2.22118,2.01357,2.26885,2.55883,2.29601,2.52152,2.57092,2.75113,2.78874,2.67702,2.62353,2.66883,2.81684,2.60053,2.73058,1.51502,1.94398,2.29866,2.01293,2.41154,2.57335,2.3759,2.45205,2.57325,2.63507,2.71198,2.92523,2.12064,2.63281,2.5827,2.78222,2.8843,2.06944,2.68131,2.57406,2.88225,2.76962,2.34552,2.46303,2.43553,2.53439,1.90371,2.04905,2.40301,2.24358,2.47882,2.77498,2.8759,1.78222,1.50759,1.61692,1.55679,2.01199,2.24511,2.19418,2.44964,2.237,2.72601,2.53814,2.85289,2.19247,1.94713,2.0716,2.41699,2.20992,2.31128,1.2592,1.07267,1.90083,1.42465,1.30509,1.57089,1.79712,1.92561,2.12203,2.28665,2.21185,2.33202,2.80907,2.69742,1.7109,1.93925,2.14894,2.29637,2.41793,2.26498,2.61192,2.53045,1.6479,1.8337,1.53696,1.94579,1.87933,2.02291,2.01206,2.33949,2.36986,2.5391,2.60222,1.4025,1.57022,1.85537,1.50339,1.86975,1.97848,2.2083,2.66157,2.38996,2.52406,2.57596,1.79578,1.84054,2.29027,2.64667,2.26137,2.28517,2.49002,2.53207,2.34397,2.62606,2.82031,1.70059,0.881405,1.29683,1.3081,1.29249,1.80897,1.33686,2.05976,1.66162,2.0155,2.38787,2.29549,2.60442,2.58118,2.46216,1.70263,1.94033,2.08652,2.34128,2.24286,2.46313,2.01454,1.82532,1.94393,2.02695,2.33336,2.17228,1.94495,2.04556,2.36265,2.45719,2.30221,2.34895,2.63893,2.65821,1.85022,1.99431,1.90115,1.91042,1.9061,2.66268,2.71333,1.66972,1.76254,1.87668,2.06007,2.17674,2.38308,2.43983,2.67481,1.57321,1.81951,2.03021,2.26322,2.45235,2.49067,1.93044,1.94279,2.04889,1.64143,2.44547,2.10982,2.31372,2.44,1.75679,1.7463,2.55632,2.21277,2.44582,1.87604,2.38184,2.38805,2.42009,0.97665,0.862956,1.52561,0.941983,1.11186,1.38199,1.26597,1.49505,1.59128,1.605,1.80484,1.75626,1.65416,1.8327,2.23803,2.21281,2.49983,2.5332,2.69837,2.94715,2.89887,2.2665,2.35049,2.72125,2.6273,2.76435,1.86934,1.72357,1.96428,2.11914,1.81795,2.39705,2.27078,1.46678,1.22393,1.27836,1.16335,1.17569,2.22493,1.62366,2.24154,2.3859,2.5864,2.28477,2.46653,2.74808,1.31082,1.19019,1.41066,1.50281,1.8449,1.7907,2.0358,2.42893,2.26562,2.30438,2.47027,2.19852,2.41531,2.20567,0.509968,0.798778,0.761282,0.891716,1.04152,1.36151,1.24037,1.64228,1.26936,1.2498,1.72655,1.56506,1.9771,2.00536,2.1204,0.835751,0.624953,1.05125,0.931567,1.19073,0.724173,0.560624,0.61999,0.282783,0.766817,1.13741,1.28325,1.41432,1.14098,1.30688,1.55485,1.53438,1.55891,1.72746,1.95819,1.73877,2.22015,2.52207,2.69671,1.42084,1.89839,1.50132,2.09728,2.28675,2.25417,2.50212,2.1509,1.61864,1.49362,1.3547,1.41097,1.26378,0.731528,0.928121,0.421902,0.978022,0.896377,0.994672,1.42848,1.41627,1.39092,1.43324,0.613509,0.672726,1.3704,0.828391,1.06912,1.0968,1.09743,1.27182,1.10965,1.74427,1.53168,1.72719,1.97969,1.14058,1.29625,1.75165,1.82719,1.82344,1.83286,2.14289,1.64575,2.12251,2.08036,2.20575,0.688063,0.761132,0.729965,1.84644,1.86918,1.46497,1.35676,0.557466,1.43367,1.86157,2.14971,1.91562,1.93557,0.578265,0.99335,1.80154,1.06062,1.597,1.64715,1.58303,1.82966,1.97695,1.86897,1.85013,2.19916,2.36868,2.43894,1.10714,0.997384,1.09301,0.584915,1.06155,1.07341,1.02233,1.2917,1.1059,0.943525,0.32237,0.9328,1.06509,1.20162,1.48044,1.39947,1.30496,1.34803,1.62482,1.20191,1.82972,1.14337,1.18692,2.06424,2.19065,2.37927,2.66468,1.76926,1.49493,1.74819,1.69375,2.42165,2.42637,2.52103,2.32073,1.68505,1.41909,1.8094,1.96117,1.72181,1.62578,1.85683,2.09088,2.31921,1.64171,1.5117,1.37437,1.69885,1.9949,1.43251,2.23621,1.79347,2.2364,2.13639,2.06095,2.65544,2.71244,1.22428,1.38384,1.93791,2.07622,2.4256,2.03086,2.28021,1.20323,1.40748,-0.793678,-1.18359,-0.0166833,-2.16125,-3.24552,-2.52522,-3.50119]
search_values = [2.67236,2.84973,3.02729,1.44065,1.6555,1.78746,1.92652,2.07364,2.22278,2.34374,2.47111,2.60236,2.73622,2.91,2.06734,2.45351,2.60857,2.75606,2.89874,3.06537,1.70637,1.97947,2.21875,2.39017,2.53426,2.68513,2.83736,3.00334,1.98481,2.23372,2.42019,2.55114,2.71636,2.861,3.03365,1.51762,1.81007,2.04441,2.17997,2.31711,2.45659,2.60134,2.75917,2.9226,1.39205,1.45669,1.51465,1.59603,1.6704,1.76917,1.93833,2.13409,2.3186,2.48272,2.61758,2.73853,2.91005,1.3336,1.4708,1.71761,1.86558,2.10946,2.25013,2.37996,2.51349,2.64752,2.7904,2.94334,1.60102,1.83135,1.93732,2.04955,2.15677,2.26768,2.39257,2.50199,2.59868,2.7628,2.14344,2.16474,2.28859,2.41671,2.67522,2.833,1.63723,1.70245,1.77254,1.66308,1.74469,1.84345,2.12681,2.30576,2.46223,2.584,2.73919,2.90691,2.12859,2.4175,2.65182,2.79975,2.97062,2.26762,2.40799,2.54959,2.64666,2.8205,2.30107,2.46896,2.6116,2.77247,1.85057,1.99805,2.1155,2.2348,2.47645,2.60605,2.75229,1.41701,1.47962,1.55038,1.60681,1.66591,1.80951,1.97762,2.13605,2.27269,2.41583,2.56224,2.72038,1.88512,2.0276,2.16452,2.28123,2.41317,2.54959,0.829453,0.9227,0.973857,1.01928,1.1495,1.49094,1.73039,1.87277,2.00706,2.13283,2.26138,2.38702,2.52705,2.67818,1.78478,1.96742,2.0952,2.20107,2.29429,2.41812,2.545,2.69287,1.27677,1.27818,1.3391,1.43043,1.72136,1.89655,2.04046,2.17853,2.31612,2.46666,2.61483,1.29019,1.47622,1.6123,1.73596,1.84222,1.94628,2.05845,2.17616,2.30363,2.43478,2.60585,1.80155,1.9433,2.04374,2.16382,2.13283,2.18191,2.26958,2.40621,2.06204,2.06425,2.39462,0.731405,0.778973,0.905787,0.986966,1.03588,1.21653,1.35712,1.78222,1.89363,2.01613,2.13424,2.2624,2.40312,2.55381,2.70484,1.97245,2.10853,2.21893,2.33023,2.42876,2.56356,0.944199,0.931193,1.08146,1.23992,1.3432,1.74785,1.80945,1.9992,2.10467,2.23025,2.28617,2.34032,2.39932,2.5559,1.5788,1.75785,2.07449,2.20481,2.33139,2.46386,2.60789,1.52146,1.75071,1.93302,2.07486,2.20932,2.35081,2.49447,2.64616,1.74853,1.73804,1.71412,1.75547,1.91715,2.02169,1.3132,1.54483,1.7565,1.87752,1.98432,2.09077,2.20678,2.3448,1.62264,1.74017,2.02571,2.11194,2.34964,1.96617,2.0619,2.10182,2.23426,0.553964,0.653613,0.743137,0.796555,0.895228,0.863794,0.987703,1.04841,1.17983,1.31743,1.4423,1.56641,1.68288,1.78813,1.99395,2.11351,2.23907,2.37053,2.50916,2.65509,2.802,2.22927,2.36676,2.50646,2.6421,2.79787,1.64588,1.73903,1.76513,1.85741,1.95896,1.99777,2.22254,0.884361,1.11428,1.34091,1.57803,1.70784,1.81472,1.92776,2.04212,2.1569,2.27911,2.41067,2.55213,2.68905,1.02969,1.06733,1.25418,1.39571,1.45038,1.52307,1.61759,1.73354,1.9409,2.06614,2.19461,2.3235,2.20213,2.36948,0.465006,0.67142,0.610907,0.729322,0.897184,1.03886,1.13551,1.20304,1.2702,1.3379,1.39783,1.49017,1.73983,1.83483,2.04093,0.524559,0.488184,0.520749,0.541372,0.52848,0.529048,0.544198,0.556482,0.608814,0.785105,0.920752,1.03145,1.17187,1.27073,1.35883,1.52634,1.62113,1.71905,1.81879,2.02369,2.24605,2.37546,2.50765,2.64332,1.74528,1.87336,1.9872,2.0966,2.17989,2.27373,2.42422,0.592048,0.627959,0.61721,0.604476,0.592244,0.579792,0.595643,0.588147,0.54149,0.547766,0.526666,0.456835,0.364342,0.253472,0.342769,0.357993,0.475304,0.636892,0.788867,0.911292,1.01584,1.08999,1.2323,1.39051,1.47599,1.57487,1.66508,1.76203,1.96134,1.35276,1.45089,1.6818,1.7678,1.80536,1.90293,2.02938,1.74184,1.72635,1.78212,1.89421,0.37033,0.42736,0.584256,0.711751,0.825461,0.892085,1.21298,1.2783,1.35383,1.76245,1.89022,2.02787,2.14048,0.820358,0.788519,1.03327,0.920091,1.10185,1.13092,1.23328,1.45686,1.61775,1.70534,1.7897,1.89177,2.01275,2.12387,0.276739,0.277003,0.287858,0.313529,0.288328,0.275362,0.246482,0.251301,0.255024,0.261819,0.312441,0.50114,0.62503,0.760802,0.85562,0.929398,1.00005,1.11852,1.18737,1.2581,1.33278,1.48314,1.56823,2.25127,2.37574,2.50958,2.64607,1.59192,1.66305,1.78933,1.9433,2.19723,2.33487,2.48647,2.63042,1.12739,1.32796,1.41116,1.52012,1.67992,1.78103,1.90774,1.98191,2.09221,0.949023,1.09393,1.17945,1.33896,1.46466,1.60692,1.72976,1.85206,1.96804,2.1963,2.31231,2.44278,2.57862,1.1694,1.63878,1.81461,1.9466,2.0718,2.20098,0.815497,-0.158518,-0.147431,-6.39683,-6.90743,-7.30348,-7.75244,-8.14386,-8.57054,-10]

function updateEnvironment(index){
    env = new Environment()
    for(i=0; i<index; i++){
        if(i == 0 || env.actionType == 1){
            env.chanceAction(actions[i])
        }
        else{
            env.agentAction(actions[i])
        }
        while(env.actionType == 0){
            // Check if there is only one valid action
            numValidActions = 0
            validAction = -1
            for(d = 0; d < 4; d++){
                if(env.validAgentAction(d)){
                    numValidActions++
                    validAction = d
                }
            }
            if(numValidActions == 1){
                env.agentAction(validAction)
            }
            else{
                break
            }
        }
    }
}


updateEnvironment(1)
currAction = actions[1]
currActionIndex = 2

/*
updateEnvironment(203)
currAction = actions[203]
currActionIndex = 204
*/
tick = 0


/*
//Manual game:
currAction = 0
tick = -1
env.randomChanceAction()
*/

console.log(env)


function fillRect(color,sx,sy,l,w){
    ctx.fillStyle = color;
    ctx.fillRect(sx,sy,l,w);
}

function drawLine(color,p1x,p1y,p2x,p2y, width){
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.beginPath();
    ctx.moveTo(p1x,p1y);
    ctx.lineTo(p2x,p2y);
    ctx.stroke();
}

function fillCirc(color,x,y,r){
    ctx.beginPath();
    ctx.arc(x,y,r,0,2*pi);
    ctx.fillStyle = color;
    ctx.fill();
}

function fillText(text,color,size,x,y){
    ctx.font = String(size)+"px Arial";
    ctx.fillStyle = color;
    ctx.textAlign = "center";
    ctx.fillText(text,x,y);
}

document.addEventListener("keydown",keyHandler);
document.addEventListener("click",clickHandler);

keyMove = ["ArrowRight","ArrowDown","ArrowLeft","ArrowUp"]

paused = true

function keyHandler(event){
    key = event.code
    event.preventDefault()
    /*
    for(i=0; i<4; i++){
        if(keyMove[i] == key){
            if(env.timer != TIME_LIMIT && env.validAgentAction(i)){
                currAction = i
                tick = 0
            }
        }
    }
    */
    if(key == "Space"){
        paused = !paused
        if(paused){
            tick = 0
        }
    }
    if(key == "ArrowRight"){
        while(true){
            currActionIndex++
            currAction = actions[currActionIndex-1]
            updateEnvironment(currActionIndex-1)
            if(env.actionType == 0){
                break
            }
        }
    }
    if(key == "ArrowLeft"){
        while(true){
            currActionIndex--
            currAction = actions[currActionIndex-1]
            updateEnvironment(currActionIndex-1)
            if(env.actionType == 0){
                break
            }
        }
    }
    if(key == "ArrowDown"){
        currActionIndex = 2
        currAction = actions[currActionIndex-1]
        updateEnvironment(currActionIndex-1)
    }
    if(key == "ArrowUp"){
        currActionIndex = actions.length - 15
        while(true){
            currActionIndex++
            currAction = actions[currActionIndex-1]
            updateEnvironment(currActionIndex-1)
            if(env.actionType == 0){
                break
            }
        }
    }
}

function clickHandler(event){
    rect = canvas.getBoundingClientRect();
    x = event.clientX - rect.left;
    y = event.clientY - rect.top;
}

function draw(){
    fillRect(space, 0, 0, windx, windy)
    fillRect(cLine, marginx - border, marginy - border, boardx*cellS + 2*border, boardy*cellS + 2*border)
    fillRect(space, marginx, marginy, boardx*cellS, boardy*cellS)
    for(var i = 0; i < boardx; i++){
        for(var j = 0; j < boardy; j++){
            if((i + j) % 2 == 0){
                fillRect(cShade, marginx + j * cellS, marginy + i * cellS, cellS, cellS)
            }
        }
    }
    fillCirc(cApple, marginx + env.appley*cellS + cellS/2, marginy + env.applex*cellS + cellS/2, appleSize/2)
    for(i = 0; i < boardx; i++){
        for(j = 0; j < boardy; j++){
            type = env.snake[i][j]
            if(type != -1){
                centerx = marginx + j*cellS + cellS/2
                centery = marginy + i*cellS + cellS/2
                slideProp = tick / framesPerMove
                if(i == env.tailx && j == env.taily && (env.headx + dir[currAction][0] != env.applex || env.heady + dir[currAction][1] != env.appley)){
                    nextx = centerx + dir[type][1] * cellS * slideProp
                    nexty = centery + dir[type][0] * cellS * slideProp
                    fillCirc(cSnake, nextx, nexty, snakeWidth / 2)
                    drawLine(cSnake, nextx, nexty, centerx + dir[type][1] * cellS, centery + dir[type][0] * cellS, snakeWidth)
                }
                else{
                    fillCirc(cSnake, centerx, centery, snakeWidth / 2)
                    if(type == 4){
                        nextDir = dir[currAction]
                        nextx = centerx + nextDir[1] * cellS * (tick / framesPerMove)
                        nexty = centery + nextDir[0] * cellS * (tick / framesPerMove)
                        drawLine(cSnake, centerx, centery, nextx, nexty, snakeWidth)
                        fillCirc(cSnake, nextx, nexty, snakeWidth / 2)
                    }
                    else{
                        drawLine(cSnake, centerx, centery, centerx + dir[type][1] * cellS, centery + dir[type][0] * cellS, snakeWidth)
                    }
                }
            }
        }
    }
    fillText("Score: " + env.score.toString(), cText, textSize, windx/2, marginy/2)
    fillText("Timer: " + env.timer.toString(), cText, textSize, windx/2, marginy/2 + textSize * 1.5)


    fillText("Value", cValue, textSize, marginx/3, textSize)
    fillText(values[currActionIndex-2].toString(), cText, textSize, marginx*2/3, textSize)
    fillText("Search Value", cSearch, textSize, marginx/3, textSize*2)
    fillText(search_values[currActionIndex-2].toString(), cText, textSize, marginx*2/3, textSize*2)
    fillText("Network Value", cNetwork, textSize, marginx/3, textSize*3)
    fillText(network_values[currActionIndex-2].toString(), cText, textSize, marginx*2/3, textSize*3)

    drawLine(cValue, marginx/4, windy/2, marginx/4, windy/2 - values[currActionIndex-2] * 25, marginx/4)

    drawLine(cSearch, marginx*2/4, windy/2, marginx*2/4, windy/2 - search_values[currActionIndex-2] * 25, marginx/4)

    drawLine(cNetwork, marginx*3/4, windy/2, marginx*3/4, windy/2 - network_values[currActionIndex-2] * 25, marginx/4)

    //fillText("Reward", cText, textSize, marginx/4, 100)
    //fillText(values[currActionIndex-1].toString(), cText, textSize, marginx/4, 120)
    //drawLine(cText, marginx/4, windy/2, marginx/4, windy/2 + rewards[currActionIndex-1] * 100, 3)
}

endState = false

function update(){
    if(endState) return
    draw()
    if(!paused){
        tick++
    }
    if(tick >= framesPerMove){
        tick = 0

        env.agentAction(currAction)
        if(env.actionType == 1){
            env.chanceAction(actions[currActionIndex])
            currActionIndex++
        }
        if(env.timer == TIME_LIMIT){
            endState = true
            return
        }

        // Check if there is only one valid action
        numValidActions = 0
        validAction = -1
        for(i = 0; i < 4; i++){
            if(env.validAgentAction(i)){
                numValidActions++
                validAction = i
            }
        }
        if(numValidActions == 0){
            endState = true
            return
        }
        if(numValidActions == 1){
            currAction = validAction
        }
        else{
            currAction = actions[currActionIndex]
            currActionIndex++
        }
    }
}

function updateManual(){
    draw()
    if(tick == -1){
        
    }
    else if(tick < framesPerMove){
        tick++
    }
    else{
        env.agentAction(currAction)
        tick = -1
        if(env.actionType == 1){
            env.randomChanceAction()
        }
    }
}

var ONE_FRAME_TIME = 1000 / 60 ;
var mainloop = function() {
    update()
    //updateManual()
};
setInterval( mainloop, ONE_FRAME_TIME );

</script>

</body>

</html>
